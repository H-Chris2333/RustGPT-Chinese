# 训练稳定化与后续改进路线（2025-10-16）

本文档总结当前已实施的稳定化措施、风险评估与建议的后续改进路径，便于持续跟踪与复现实验。

## 一、当前状态与已实施稳定器

- 损失计算：改为 log_softmax + NLL（交叉熵从对数概率计算），反向梯度为 softmax(logits) - one_hot(target)，数值更稳定。
- 梯度裁剪：max_norm=1.0，应用于经典训练与监控训练路径。
- 学习率调度：cosine annealing，无重启（num_restarts=0），避免 LR 周期性尖峰。
- 梯度累积：暂时禁用（accumulation_steps=1）以降低方差与状态复杂度。
- 早停策略：小数据集预训练 patience=30，加速迭代反馈。
- 注意力冻结开关：SelfAttention.freeze_updates 支持跳过 Q/K/V/O 的 Adam 更新（序列化已适配）。

编译状态：cargo build 成功（llm.rs 存在未使用导入 LOG_EPSILON 的 warning）。

默认训练参数（main.rs）：
- 预训练：max_epochs=500, lr=1e-4, patience=30, accumulation_steps=1, 余弦退火无重启, grad clip=1.0。
- 指令微调：仍保留旧参数（lr=3e-4, patience=80, restarts=2, accum=4），建议在预训练稳定后统一调整。

## 二、已知风险与诊断

- SelfAttention::backward 为近似实现，若 LR 偏大或梯度过强仍可能不稳。可临时启用 freeze_updates 隔离注意力权重更新，先稳定其他层。
- 数据集较小：损失与困惑度波动较大属预期；稳定器将降低爆炸概率但不消除方差。

## 三、验证与观测指标

- 短跑验证：运行少量 epoch（如 20-30），观察：
  - Loss：总体缓降，无爆炸；
  - PPL：不过度上升，趋势稳定；
  - Grad Norm：不呈持续上升趋势；
  - 速度（samples/s）：用于对比不同设置。

## 四、建议的后续改进路线（优先级从高到低）

1) 非交互短跑入口（高）
- 增加 CLI 选项（不引入新依赖，使用 std::env::args）：
  - `--quick`：预设 pretrain_epochs=30, lr=1e-4, patience=10, accum=1，仅跑预训练并输出监控日志；
  - `--pretrain-epochs=NUM`、`--lr=FLOAT`、`--patience=NUM`、`--accum=NUM` 自定义超参；
  - `--freeze-attn`：统一将所有 SelfAttention.freeze_updates 设为 true；
  - `--no-interactive`：训练后跳过保存/测试/交互，方便自动化验证。
- 价值：一条命令即可重现实验与采集日志，降低人工交互成本。

2) 统一微调超参（中-高）
- 将微调阶段对齐稳定配置：lr≈3e-5–1e-4、patience≈30、无重启、clip=1.0，累积从 1→2→4 渐进恢复。

3) 标签平滑（中）
- 在稳定后可加入 ε=0.1 的 label smoothing，缓解过拟合与过度自信，注意重新校准学习率。

4) 注意力冻结策略（中）
- 若短跑仍不稳，预训练前若干 epoch 启用 `freeze_updates=true`，验证稳定后再解冻逐步微调；
- 可扩展为“分层解冻”（先解冻投影/FFN，后解冻注意力）。

5) 监控增强（中）
- 记录/导出每 epoch：avg_loss、ppl、avg_grad_norm、lr、samples/s；
- 可选写入 JSON 或纯文本日志，便于可视化。

6) 技术债与整理（中-低）
- 移除未使用导入（LOG_EPSILON）；
- 在 LLM 中提供 `set_attention_freeze_updates(bool)` 以统一设置所有 TransformerBlock 的注意力冻结；
- 明确 SelfAttention::backward 的近似假设，文档化边界条件。

## 五、里程碑与执行清单

- M1：非交互 CLI 短跑（完成后执行一次验证并附日志样例）
- M2：统一微调超参并完成短跑验证
- M3：可选启用标签平滑，评估与对照
- M4：分层解冻策略验证（如需要）
- M5：监控导出与可视化（CSV/图表）

## 六、示例命令（规划）

- 快速验证（默认稳定参数）：
```
cargo run --release -- --quick --no-interactive
```
- 自定义参数并冻结注意力：
```
cargo run --release -- --pretrain-epochs=30 --lr=1e-4 --patience=10 --accum=1 --freeze-attn --no-interactive
```

---
如需我实现 M1（CLI 短跑入口）请告知，我将按上述方案提交变更并附验证步骤。